var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},DragonBonesView=function(t){function e(){var e=t.call(this)||this;return e._viewStage=new egret.DisplayObjectContainer,e._armatureContainer=new egret.DisplayObjectContainer,e._viewStage.addChild(e._armatureContainer),e.addChild(e._viewStage),e}return __extends(e,t),e.prototype._modelEventHandler=function(t){switch(t.type){case DragonBonesModelEvent[DragonBonesModelEvent.ArmatureAdd]:var e=t.data;this._armatureContainer.addChild(e.display);break;case DragonBonesModelEvent[DragonBonesModelEvent.ArmatureRemove]:var e=t.data;this._armatureContainer.removeChild(e.display)}},e.prototype.init=function(t){this._model=t,DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureAdd],this._modelEventHandler,this),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureRemove],this._modelEventHandler,this)},e}(egret.DisplayObjectContainer);__reflect(DragonBonesView.prototype,"DragonBonesView");var DragonBonesControl=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.getInstance=function(){return null===e._instance&&(e._instance=new egret.EventDispatcher),e._instance},e}(egret.EventDispatcher);DragonBonesControl._instance=null,__reflect(DragonBonesControl.prototype,"DragonBonesControl");var DragonBonesModelEvent;!function(t){t[t.DragonBonesChange=100]="DragonBonesChange",t[t.ArmatureAdd=101]="ArmatureAdd",t[t.ArmatureRemove=102]="ArmatureRemove",t[t.ArmatureChange=103]="ArmatureChange",t[t.AnimationStart=104]="AnimationStart",t[t.AnimationComplete=105]="AnimationComplete",t[t.AnimationPlay=106]="AnimationPlay",t[t.AnimationStop=107]="AnimationStop",t[t.AnimationChange=108]="AnimationChange"}(DragonBonesModelEvent||(DragonBonesModelEvent={}));var DragonBonesModel=function(){function t(){this._armatures=[],this._inputData=null,this._dragonBonesData=null,this._armature=null,this._animation=null}return t.prototype._animationHandler=function(t){switch(t.type){case dragonBones.EventObject.FADE_IN:t.animationState&&(this._animation&&this._animation.name===t.animationState.name||(this._animation=t.animationState,DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.AnimationChange],!1,this._animation)),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.AnimationStart],!1,this._animation));break;case dragonBones.EventObject.COMPLETE:DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.AnimationComplete],!1,this._animation)}},t.prototype.init=function(){},t.prototype.addArmature=function(t){var e=dragonBones.EgretFactory.factory.buildArmatureDisplay(t);return null!==e?(this._armatures.push(e.armature),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureAdd],!1,e.armature),e.armature):null},t.prototype.removeArmature=function(t){this.armature===t&&(this.armature=null);var e=this._armatures.indexOf(t);e>=0&&(this._armatures.splice(e,1),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureRemove],!1,t),t.dispose())},t.prototype.clearAllArmature=function(){for(var t=this._armatures.length;t--;){var e=this._armatures[t];this.removeArmature(e)}},t.prototype.changeArmature=function(t){if(this._dragonBonesData){this._armature&&this.removeArmature(this._armature);var e=this._dragonBonesData.armatureNames;t%=e.length,0>t&&(t=e.length+t),this.armature=this.addArmature(e[t]),this.playAnimation()}},t.prototype.prevArmature=function(){this._dragonBonesData&&(this._armature?this.changeArmature(this._dragonBonesData.armatureNames.indexOf(this._armature.name)-1):this.changeArmature(0))},t.prototype.nextArmature=function(){this._dragonBonesData&&(this._armature?this.changeArmature(this._dragonBonesData.armatureNames.indexOf(this._armature.name)+1):this.changeArmature(0))},t.prototype.playAnimation=function(){this._armature&&(this._armature.animation.lastAnimationState?this._armature.animation.lastAnimationState.isCompleted?this._armature.animation.play():this._armature.animation.lastAnimationState.play():this._armature.animation.play(),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.AnimationPlay],!1))},t.prototype.stopAnimation=function(){this._armature&&(this._armature.animation.lastAnimationState?this._armature.animation.lastAnimationState.stop():this._armature.animation.stop(),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.AnimationStop],!1))},t.prototype.changeAnimation=function(t){if(this._armature){var e=this._armature.armatureData.animationNames;t%=e.length,0>t&&(t+=e.length),this._armature.animation.fadeIn(e[t])}},t.prototype.prevAnimation=function(){if(this._armature)if(this._animation){var t=this._armature.armatureData.animationNames;this.changeAnimation(t.indexOf(this._animation.name)-1)}else this._armature.animation.play()},t.prototype.nextAnimation=function(){if(this._armature)if(this._animation){var t=this._armature.armatureData.animationNames;this.changeAnimation(t.indexOf(this._animation.name)+1)}else this._armature.animation.play()},Object.defineProperty(t.prototype,"armatures",{get:function(){return this._armatures},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputData",{get:function(){return this._inputData},set:function(t){if(this._inputData!==t){if(this.clearAllArmature(),this._inputData=t,this._inputData){console.assert(null!=this._inputData.data),console.assert(null!=this._inputData.textures);var e=this._inputData.textures;e.forEach(function(t,e,n){if(t instanceof egret.Texture);else if(t){var a=new egret.Texture,o=document.getElementById(t);o?(a.bitmapData=new egret.BitmapData(o),n[e]=a):n[e]=null}}),dragonBones.EgretFactory.factory.clear(!0),this._dragonBonesData=dragonBones.EgretFactory.factory.parseDragonBonesData(this._inputData.data),this._dragonBonesData&&(dragonBones.EgretFactory.factory.getTextureAtlasData(this._dragonBonesData.name)?dragonBones.EgretFactory.factory.updateTextureAtlasData(this._dragonBonesData.name,e):this._inputData.textureAtlases.forEach(function(t,n){dragonBones.EgretFactory.factory.parseTextureAtlasData(t,e[n])}))}DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.DragonBonesChange],!1,this._inputData)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dragonBonesData",{get:function(){return this._dragonBonesData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"armature",{get:function(){return this._armature},set:function(t){this._armature!==t&&(this._animation=null,DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.AnimationChange],!1,null),this._armature&&(this._armature.removeEventListener(dragonBones.EventObject.FADE_IN,this._animationHandler,this),this._armature.removeEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)),this._armature=t,this._armature&&(this._armature.addEventListener(dragonBones.EventObject.FADE_IN,this._animationHandler,this),this._armature.addEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)),DragonBonesControl.getInstance().dispatchEventWith(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureChange],!1,this._armature))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),t}();DragonBonesModel.HIDE="hide",DragonBonesModel.DATA="data",__reflect(DragonBonesModel.prototype,"DragonBonesModel");var DragonBonesUtils=function(){function t(){}return t.isDragonBonesString=function(t){var e=t.substr(0,Math.min(200,t.length));return e.indexOf("armature")>0},t.loadFiles=function(t,e){for(var n=[],a=(function(a){var o=a.target,r=o.file;if("image/png"===r.type?n.push(o):n.unshift(o),n.length===t.length){var i={data:null,textureAtlases:[],textures:[]},s=0;n.forEach(function(t){var e=t.file;if("image/png"===e.type){var n=document.createElement("img");n.id="textureAtlas_"+ ++s,n.src=t.result;var a=document.getElementById(DragonBonesModel.HIDE);if(a){var o=document.getElementById(n.id);o&&(o.id="",o.src="",a.removeChild(o)),a.appendChild(n)}}else{var r=t.result;try{var l=JSON.parse(r);"armature"in l?i.data||(i.data=l):(i.textureAtlases.push(l),i.textures.push("textureAtlas_"+(i.textures.length+1)))}catch(m){}}}),e(i)}}),o=0,r=t.length;r>o;++o){var i=t[o];if("image/png"===i.type){var s=new FileReader;s.file=i,s.onload=a,s.readAsDataURL(i)}else if(i.name.indexOf(".json")>0){var s=new FileReader;s.file=i,s.onload=a,s.readAsBinaryString(i)}}},t}();__reflect(DragonBonesUtils.prototype,"DragonBonesUtils");var Main=function(t){function e(){var e=t.call(this)||this;return e.model=new DragonBonesModel,e.view=new DragonBonesPlayerView,e.addEventListener(egret.Event.ADDED_TO_STAGE,e._addToStageHandler,e),e.addChild(e.view),e}return __extends(e,t),e.prototype._addToStageHandler=function(){this._init()},e.prototype._init=function(){var t=this;this.model.init(),this.view.init(this.model);var e=document.getElementById(DragonBonesModel.DATA);if(e&&(this.model.inputData=JSON.parse(e.innerHTML),this._changeArmatureAndAnimation()),!egret.Capabilities.isMobile){var n=document.body;n.ondragenter=n.ondragover=function(t){t.stopPropagation(),t.preventDefault()},n.ondrop=function(e){e.stopPropagation(),e.preventDefault();var n=e.dataTransfer;n&&n.files&&DragonBonesUtils.loadFiles(n.files,function(e){t.model.inputData=e,t._changeArmatureAndAnimation()})}}},e.prototype._changeArmatureAndAnimation=function(){if(this.model.inputData&&this.model.dragonBonesData){var t=this.model.inputData.armature;if(t){var e=this.model.dragonBonesData.armatureNames.indexOf(t);this.model.changeArmature(e)}else this.model.changeArmature(0);if(this.model.armature){var n=this.model.inputData.animation;if(n){var e=this.model.armature.armatureData.animationNames.indexOf(n);this.model.changeAnimation(e)}else this.model.changeAnimation(0)}}},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DragonBonesPlayerView=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._isComplete=!1,e}return __extends(e,t),e.prototype._modelEventHandler=function(e){switch(t.prototype._modelEventHandler.call(this,e),e.type){case DragonBonesModelEvent[DragonBonesModelEvent.ArmatureChange]:var n=e.data,a=n.display;this._model.inputData&&this._model.inputData.config&&(a.x=-this._model.inputData.config.x,a.y=-this._model.inputData.config.y);var o=document.getElementById("dragonbones-player");o&&this._model.inputData&&this._model.inputData.config&&(o.style.backgroundColor=this._model.inputData.config.backgroundColor),a.addEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this);break;case DragonBonesModelEvent[DragonBonesModelEvent.ArmatureRemove]:var n=e.data,a=n.display;a.removeEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)}},e.prototype._animationHandler=function(t){switch(t.type){case dragonBones.EventObject.COMPLETE:if(!this._model.armature||!this._model.animation)return;var e=this._model.armature.armatureData.animationNames;if(e.length>1){var n=e.indexOf(this._model.animation.name);n===e.length-1?this._isComplete=!0:this._model.nextAnimation()}else this._isComplete=!0}},e.prototype._touchHandler=function(t){if(this._isComplete)switch(t.type){case egret.TouchEvent.TOUCH_BEGIN:break;case egret.TouchEvent.TOUCH_END:this._model.changeAnimation(0)}},e.prototype._resizeHandler=function(t){this._viewStage.x=.5*this.stage.stageWidth,this._viewStage.y=.5*this.stage.stageHeight},e.prototype.init=function(e){t.prototype.init.call(this,e),DragonBonesControl.getInstance().addEventListener(DragonBonesModelEvent[DragonBonesModelEvent.ArmatureChange],this._modelEventHandler,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this._touchHandler,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this._touchHandler,this),this.stage.addEventListener(egret.Event.RESIZE,this._resizeHandler,this)},e}(DragonBonesView);__reflect(DragonBonesPlayerView.prototype,"DragonBonesPlayerView");